---
layout: page
title: 자연어 처리 - 텍스트
subtitle: "공정거래법 전면개편안"
author:
  - name: "[Tidyverse Korea](https://www.facebook.com/groups/tidyverse/)"
    url: https://www.facebook.com/groups/tidyverse/
    affiliation: Tidyverse Korea
    affiliation_url: https://www.facebook.com/groups/tidyverse/
date: "`r Sys.Date()`"
output:
  html_document: 
    include:
      after_body: footer.html
      before_body: header.html
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: true
    highlight: tango
    code_folding: show
    number_section: true
    self_contained: true
bibliography: bibliography.bib
csl: biomed-central.csl
urlcolor: blue
linkcolor: blue
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      comment="", digits = 3, tidy = FALSE, prompt = FALSE, fig.align = 'center')

library(pdftools)
library(tidyverse)
library(magick)
```


# 공정거래법 국회공청회 [^fair-hearing] {#fair-parliment}

[^fair-hearing]: [한정렬 2020.07.07 10:44, "더민주당 박용진, 오후2시 '공정거래법' 개편안 토론회 개최", 데일리메디팜](http://www.dailymedipharm.com/news/articleView.html?idxno=51894)

더민주당 박용진 국회의원(강북을)은 7일 오후 2시 국회도서관 소회의실에서 '공정거래법 전면개편안 어떻게 바꿔야 하나?'토론회를 개최했다. 공청회 진행 시 배부된 책자를 받아 Digitization 과정을 거쳐 텍스트 마이닝을 거쳐 MRC 작업을 수행해보자.

# Digitization 작업 {#digitization-workflow}

배부된 책자를 원활히 스캔하기 위해서 분책하는 과정을 거친다. 그리고 나서 스캐너에 넣어 배부집 전체를 스캔한다. 스캔된 결과는 파일이 크지만 600 DPI로 Digitization 과정을 거쳐 PDF 파일로 저장한다. 

![](fig/fair_data.png)

PDF 파일을 PNG로 변환시켜 직접 살펴보기 위한 준비작업을 수행한다.

```{r fair-law, eval = FALSE}
library(pdftools)
library(tidyverse)
library(magick)

# 공청회 배부집 PDF 파일정보, 총페이지수
fair_pdf_info <- pdf_info("data/fair_hearing.pdf")

dir.create("fig/fair")

# PDF 파일 PNG  변환
pdf_convert("data/fair_hearing.pdf", pages = 1:fair_pdf_info$pages, filename = glue::glue("fig/fair/fair_{1:fair_pdf_info$pages}.png"))
```

`slickR`에 태우기 위해 데이터프레임 변환과정을 거쳐 빠르게 공정거래법 전면개편안을 살펴볼 수 있도록 작업한다.

```{r fair-law-merry-go-round}
library(slickR)

fair_png <- list.files("fig/fair")
fair_pdf_df <- tibble(page = glue::glue("fig/fair/{fair_png}") )
  
bottom_opts <- settings(arrows = TRUE,
                        slidesToShow = 3,
                        slidesToScroll = 1,
                        centerMode = TRUE, 
                        focusOnSelect = TRUE,
                        initialSlide = 0)

slickR(fair_pdf_df$page, height = 600) %synch% 
  (slickR(fair_pdf_df$page, height = 100) + bottom_opts)
```

# 텍스트 추출 {#extract-text-from-pdf}

한국어 OCR을 위한 오픈소스 팩키지로 `tesseract`가 가장 널리 알려져 있고, `EasyOCR`도 관심을 가지고 지켜볼 팩키지로 부상하고 있다.

- [`tesseract`](https://github.com/tesseract-ocr)
- [`EasyOCR`](https://github.com/JaidedAI/EasyOCR)


```{r ocr-tesseract}
library(tesseract)

fair_pdf <- image_read_pdf("data/fair_hearing.pdf")

if(is.na(match("kor", tesseract_info()$available)))
  tesseract_download("kor")

fair_text <- tesseract::ocr(fair_pdf, engine = tesseract(language = "kor"))  

fair_text[1]
```

## 이미지 결합 {#image-combined}

OCR 원본 이미지와 OCR 된 글자를 파악하기 위해서 다음과 같이 비교가능한 이미지를 만들어보자.

```{r image-combined}

sample_png <- image_read("fig/fair/fair_3.png")

white_png <- image_blank(550, 756, color = "white", pseudo_image = "", defines = NULL)

combined_img <- c(sample_png, white_png)

image_append(combined_img, stack = FALSE)
```

## OCR된 텍스트 [^hangul-magick] {#image-combined-ocred}

[^hangul-magick]: [`ropensci/magick`, "non-english is broken #119", GitHub](https://github.com/ropensci/magick/issues/119)

`tesseract` 통해서 OCR 작업된 텍스트를 원본 이미지 문서 페이지와 비교하기 위해서 다음과 같이 작업한다. 

```{r image-combined-ocred}
annotated_png <- white_png %>% 
  image_annotate(fair_text[3], location = "+100+100", size = 17, font = "AppleGothic")

annotated_png
```

## OCR 결과 결합 {#image-combined-ocred-combined}

`OCR` 결과를 원본 이미지 페이지와 결합시킨다. 
`display_ocr_text()` 함수를 넣어 페이지를 넣게 되면 원본 이미지와 OCR된 텍스트가 함께 표시되어 OCR 결과를 비교할 수 있도록 준비한다.

```{r image-combined-ocred-combined}

display_ocr_text <- function(page) {
  ## 빈 도화지 + OCR된 텍스트
  white_png <- image_blank(550, 756, color = "white", pseudo_image = "", defines = NULL)
  annotated_png <- white_png %>% 
    image_annotate(fair_text[page], location = "+100+100", size = 17, font = "AppleGothic")
  
  ## 원본 이미지
  pdf_page <- glue::glue("fig/fair/fair_{page}.png")
  sample_png <- image_read(pdf_page)
  
  ## 결합
  combined_img <- c(sample_png, annotated_png)
  return(image_append(combined_img, stack = FALSE))
}

display_ocr_text(11)
```


## 전체 비교 {#image-combined-ocred-combined-all}

먼저 앞서 원본 PDF 파일 페이지와 OCR된 결과를 비교할 수 있었다면, 이번에는 이미지 작업결과를 저장시키는 함수를 `save_ocr_text_png()`으로 작성하고 반복문을 이용하여 PDF 전체 페이지를 특정 디렉토리 `"fig/fair_ocr"`에 저장시킨다.

```{r image-combined-ocred-combined-all, eval = FALSE}

save_ocr_text_png <- function(page) {
  ## 빈 도화지 + OCR된 텍스트
  white_png <- image_blank(550, 756, color = "white", pseudo_image = "", defines = NULL)
  annotated_png <- white_png %>% 
    image_annotate(fair_text[page], location = "+100+100", size = 14, font = "AppleGothic")
  
  ## 원본 이미지
  pdf_page <- glue::glue("fig/fair/fair_{page}.png")
  sample_png <- image_read(pdf_page)
  
  ## 결합
  combined_img <- c(sample_png, annotated_png)
  annotated_img <- image_append(combined_img, stack = FALSE)
  
  dir.create("fig/fair_ocr", showWarnings = FALSE)
  
  image_write(annotated_img, glue::glue("fig/fair_ocr/fair_ocr_{page}.png"))
}

fair_pdf_info <- pdf_info("data/fair_hearing.pdf")

map(1:fair_pdf_info$pages, save_ocr_text_png)
```

`tessearact` OCR 성능을 시각적으로 전체적으로 파악하기 위해서 다시 한번 회전목마를 돌려 일별한다.


```{r fair-law-ocr-merry-go-round}
fair_ocr_png <- list.files("fig/fair_ocr/")
fair_pdf_ocr_df <- tibble(page = glue::glue("fig/fair_ocr/{fair_ocr_png}") )
  
bottom_opts <- settings(arrows = TRUE,
                        slidesToShow = 3,
                        slidesToScroll = 1,
                        centerMode = TRUE, 
                        focusOnSelect = TRUE,
                        initialSlide = 0)

slickR(fair_pdf_ocr_df$page, height = 600) %synch% 
  (slickR(fair_pdf_ocr_df$page, height = 100) + bottom_opts)
```


